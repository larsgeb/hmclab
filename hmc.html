<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Installation" href="setup.html" /><link rel="prev" title="HMC Lab" href="index.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.04.07"/>
        <title>The Hamiltonian Monte Carlo algorithm - Version 1.0</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=68f4518137b9aefe99b631505a2064c3c42c9852" />
    <link rel="stylesheet" type="text/css" href="_static/autoclasstoc.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Version 1.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="_static/HMC Lab.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="_static/HMC Lab-dark.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Version 1.0</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">HMC Lab</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">The Hamiltonian Monte Carlo algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="notebooks.html">Notebooks: Examples and tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="notebooks/tutorials/0%20-%20Getting%20started.html">Tutorial 0 - Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/tutorials/1%20-%20Tuning%20Hamiltonian%20Monte%20Carlo.html">Tutorial 1 - Tuning Hamiltonian Monte Carlo</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/tutorials/2%20-%20Separate%20priors%20per%20dimension.html">Tutorial 2 - Separate priors per dimension</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/tutorials/3%20-%20Creating%20your%20own%20inverse%20problem.html">Tutorial 3 - Creating your own inverse problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/tutorials/4%20-%20Running%20parallel%20Markov%20chains.html">Tutorial 4 - Running parallel Markov chains</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/tutorials/5%20-%20Transforming%20parameters.html">Tutorial 5 - Transforming existing distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/examples/Sampling%20linear%20equations.html">Linear (dense) forward operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/examples/Sampling%20sparse%20linear%20equations.html">Linear (sparse) forward operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/examples/Locating%20quakes%20on%20Grimsv%C3%B6tn%2C%20Iceland.html">Locating quakes on Grimsvötn, Iceland</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks/examples/Elastic%202d%20FWI.html">Probabilistic Elastic FWI</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api/index.html">API reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="api/distributions/index.html">Distributions</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions._AbstractDistribution.html">_AbstractDistribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.StandardNormal1D.html">StandardNormal1D</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.Normal.html">Normal</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.Laplace.html">Laplace</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.Uniform.html">Uniform</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.LinearMatrix.html">LinearMatrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.CompositeDistribution.html">CompositeDistribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.AdditiveDistribution.html">AdditiveDistribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.BayesRule.html">BayesRule</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.Himmelblau.html">Himmelblau</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.SourceLocation2D.html">SourceLocation2D</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/distributions/_autosummary/hmclab.Distributions.SourceLocation3D.html">SourceLocation3D</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="api/massmatrices/index.html">MassMatrices</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="api/massmatrices/_autosummary/hmclab.MassMatrices._AbstractMassMatrix.html">_AbstractMassMatrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/massmatrices/_autosummary/hmclab.MassMatrices.Unit.html">Unit</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/massmatrices/_autosummary/hmclab.MassMatrices.Diagonal.html">Diagonal</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="api/samplers/index.html">Samplers</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="api/samplers/_autosummary/hmclab.Samplers._AbstractSampler.html">_AbstractSampler</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/samplers/_autosummary/hmclab.Samplers.RWMH.html">RWMH</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/samplers/_autosummary/hmclab.Samplers.HMC.html">HMC</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="api/optimizers/index.html">Optimizers</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="api/optimizers/_autosummary/hmclab.Optimizers.gradient_descent.html">hmclab.Optimizers.gradient_descent</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="api/visualization/index.html">Visualization</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="api/visualization/marginal.html">marginal</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/visualization/marginal_grid.html">marginal_grid</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/visualization/visualize_2_dimensions.html">visualize_2_dimensions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api/_autosummary/hmclab.Samples.html">Samples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="py-modindex.html">Module index</a></li>
<li class="toctree-l1"><a class="reference internal" href="genindex.html">Alphabetic index</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="the-hamiltonian-monte-carlo-algorithm">
<h1>The Hamiltonian Monte Carlo algorithm<a class="headerlink" href="#the-hamiltonian-monte-carlo-algorithm" title="Permalink to this headline">#</a></h1>
<p>Originally developed for molecular dynamics under the name hybrid Monte Carlo <span id="id1">[<a class="reference internal" href="#id299" title="S. Duane, A. D. Kennedy, B. J. Pendleton, and D. Roweth. Hybrid Monte Carlo. Phys. Lett. B, 195:216-222, 1987.">1</a>]</span>, Hamiltonian Monte Carlo (HMC) is now commonly used for the subset of sampling problems where gradients of the posterior <span class="math notranslate nohighlight">\(p(\mathbf{m}|\mathbf{d}_\text{obs})\)</span> with respect to the model parameters <span class="math notranslate nohighlight">\(\mathbf{m}\)</span> are easy to compute. The cost of generating independent samples with HMC under increasing dimension <span class="math notranslate nohighlight">\(n\)</span> grows as <span class="math notranslate nohighlight">\(\mathcal{O}(n^{5/4})\)</span> <span id="id2">[<a class="reference internal" href="#id803" title="R. M. Neal. MCMC using Hamiltonian dynamics. In Handbook of Markov Chain Monte Carlo, Chapter 5. 2011.">2</a>]</span>, whereas it grows as <span class="math notranslate nohighlight">\(\mathcal{O}(n^2)\)</span> for  standard Metropolis-Hastings <span id="id3">[<a class="reference internal" href="#id238" title="Michael Creutz. Global monte carlo algorithms for many-fermion systems. Physical Review D, 38(4):1228, 1988.">3</a>]</span>.</p>
<section id="theory">
<h2>Theory<a class="headerlink" href="#theory" title="Permalink to this headline">#</a></h2>
<p>HMC constructs a Markov chain over an <span class="math notranslate nohighlight">\(n\)</span>-dimensional probability density function <span class="math notranslate nohighlight">\(p(\mathbf{m})\)</span> using classical Hamiltonian mechanics <span id="id4">[<a class="reference internal" href="#id636" title="L. D. Landau and E. M. Lifshitz. Course of Theoretical Physics, Volume 1, Mechanics, 3rd edition. Elsevier Butterworth Heinemann, Amsterdam, 1976.">4</a>]</span>. The algorithm regards the current state <span class="math notranslate nohighlight">\(\mathbf{m}\)</span> of the Markov chain as the location of a physical particle in <span class="math notranslate nohighlight">\(n\)</span>-dimensional space <span class="math notranslate nohighlight">\(\mathbb{M}\)</span>. It moves under the influence of a potential energy, <span class="math notranslate nohighlight">\(U\)</span>, which is defined as</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\begin{eqnarray}
    U (\mathbf{m}) = - \ln p(\mathbf{m})\,.
\end{eqnarray}</div></div><p>In the case of a Gaussian probability density <span class="math notranslate nohighlight">\(p\)</span>, the potential energy <span class="math notranslate nohighlight">\(U\)</span> is equal to the least-squares misfit <span class="math notranslate nohighlight">\(\chi(\mathbf{m})\)</span>. To complete the physical system, the state of the Markov chain needs to be artificially augmented with momentum variables <span class="math notranslate nohighlight">\(\mathbf{p}\)</span> for every dimension and a generalized mass for every dimension pair.
The collection of resulting masses are contained in a positive definite mass matrix <span class="math notranslate nohighlight">\(\mathbf{m}\)</span> of dimension <span class="math notranslate nohighlight">\(n\times n\)</span>. The momenta and the mass matrix define the kinetic energy of a model as</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\begin{eqnarray}
    K(\mathbf{p}) = \frac{1}{2}\mathbf{p}^T \mathbf{M}^{-1} \mathbf{p}\,.
\end{eqnarray}</div></div><p>In the HMC algorithm, the momenta <span class="math notranslate nohighlight">\(\mathbf{p}\)</span> are drawn randomly from a multivariate Gaussian with covariance matrix <span class="math notranslate nohighlight">\(\mathbf{m}\)</span>. The location-dependent potential and kinetic energies constitute the total energy or Hamiltonian of the system,</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\begin{eqnarray}
     H(\mathbf{m}, \mathbf{p}) = U(\mathbf{m}) + K(\mathbf{p}).
\end{eqnarray}</div></div><p>Hamilton’s equations</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\begin{eqnarray}
    \frac{d \mathbf{m}}{d \tau}  =  \frac{\partial H}{\partial \mathbf{p}}\,, \qquad
    \frac{d \mathbf{p}}{d \tau}  =  - \frac{\partial H}{\partial \mathbf{m}}\,,
\end{eqnarray}</div></div><p>determine the position of the particle as a function of the artificial time variable <span class="math notranslate nohighlight">\(\tau\)</span>. We can simplify Hamilton’s equations using the fact that kinetic and potential energy depend only on momentum and location, respectively,</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\begin{eqnarray}
    \frac{d \mathbf{m}}{d \tau}  =  \mathbf{M}^{-1} \mathbf{p}\,,\qquad
    \frac{d \mathbf{p}}{d \tau}  =  - \frac{\partial U}{\partial \mathbf{m}}\,.
\end{eqnarray}</div></div><p>Evolving <span class="math notranslate nohighlight">\(\mathbf{m}\)</span> over time <span class="math notranslate nohighlight">\(\tau\)</span> generates another possible state of the system with new position <span class="math notranslate nohighlight">\(\mathbf{\tilde{m}}\)</span>, momentum <span class="math notranslate nohighlight">\(\mathbf{\tilde{p}}\)</span>, potential energy <span class="math notranslate nohighlight">\(\tilde{U}\)</span>, and kinetic energy <span class="math notranslate nohighlight">\(\tilde{K}\)</span>. Due to the conservation of energy, the Hamiltonian is equal in both states. Successively drawing random momenta and evolving the system generates a distribution of the possible states of the system. Thereby, HMC samples the joint momentum and model space, referred to as phase space. As we are not interested in the momentum component of phase space, we marginalize over the momenta by simply dropping them. This results in samples drawn from <span class="math notranslate nohighlight">\(p(\mathbf{m})\)</span>.</p>
</section>
<section id="from-theory-to-code">
<h2>From theory to code<a class="headerlink" href="#from-theory-to-code" title="Permalink to this headline">#</a></h2>
<p>If one could solve Hamilton’s equations exactly, every proposed state would be a valid sample of <span class="math notranslate nohighlight">\(p(\mathbf{m})\)</span>. Since Hamilton’s equations for non-linear forward models cannot be solved analytically, the system must be integrated numerically. Suitable integrators are symplectic, meaning that time reversibility, phase space partitioning and volume preservation are satisfied <span id="id5">[<a class="reference internal" href="#id803" title="R. M. Neal. MCMC using Hamiltonian dynamics. In Handbook of Markov Chain Monte Carlo, Chapter 5. 2011.">2</a>, <a class="reference internal" href="#id367" title="A. Fichtner and A. Zunino. Hamiltonian nullspace shuttles. Geophys. Res. Lett., 46:doi:10.1029/2018GL080931, 2019.">5</a>]</span>. However, the Hamiltonian is generally not preserved exactly when explicit time-stepping schemes are used. In this work, we employ the leapfrog method as described in <span id="id6">Neal [<a class="reference internal" href="#id803" title="R. M. Neal. MCMC using Hamiltonian dynamics. In Handbook of Markov Chain Monte Carlo, Chapter 5. 2011.">2</a>]</span>. As the Hamiltonian is not preserved, the time evolution generates samples not exactly proportional to the original distribution. A Metropolis-Hastings correction step is therefore applied at the end of numerical integration.</p>
<p>In summary, samples are generated starting from a random model <span class="math notranslate nohighlight">\(\mathbf{m}\)</span> in the following way:</p>
<div class="admonition-the-hamiltonian-monte-carlo-algorithm admonition">
<p class="admonition-title">The Hamiltonian Monte Carlo algorithm</p>
<ol class="arabic simple">
<li><p>Propose momenta <span class="math notranslate nohighlight">\(\mathbf{p}\)</span> according to the Gaussian with mean <span class="math notranslate nohighlight">\(\mathbf{0}\)</span> and covariance <span class="math notranslate nohighlight">\(\mathbf{m}\)</span>;</p></li>
<li><p>Compute the Hamiltonian <span class="math notranslate nohighlight">\(H\)</span> of model <span class="math notranslate nohighlight">\(\mathbf{m}\)</span> with momenta <span class="math notranslate nohighlight">\(\mathbf{p}\)</span>;</p></li>
<li><p>Propagate <span class="math notranslate nohighlight">\(\mathbf{m}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{p}\)</span> for some time <span class="math notranslate nohighlight">\(\tau\)</span> to <span class="math notranslate nohighlight">\(\tilde{\mathbf{m}}\)</span> and <span class="math notranslate nohighlight">\(\tilde{\mathbf   {p}}\)</span>, using the discretized version of Hamilton’s equations and a suitable numerical integrator;</p></li>
<li><p>Compute the Hamiltonian <span class="math notranslate nohighlight">\(\tilde{H}\)</span> of model <span class="math notranslate nohighlight">\(\tilde{\mathbf{m}}\)</span> with momenta <span class="math notranslate nohighlight">\(\mathbf{\tilde{p}}\)</span>;</p></li>
<li><p>Accept the proposed move <span class="math notranslate nohighlight">\(\mathbf{m} \rightarrow \tilde{\mathbf{m}}\)</span> with probability</p></li>
</ol>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\begin{eqnarray}
    p_\text{accept} = \min \left( 1, \exp ( H-\tilde{H} ) \right)\,.
\end{eqnarray}</div></div><ol class="arabic simple" start="6">
<li><p>If accepted, use (and count) <span class="math notranslate nohighlight">\(\tilde{\mathbf{m}}\)</span> as the new state. Otherwise, keep (and count) the previous state. Then return    to 1.</p></li>
</ol>
</div>
</section>
<section id="hmc-compared">
<h2>HMC compared<a class="headerlink" href="#hmc-compared" title="Permalink to this headline">#</a></h2>
<p>The main factor influencing the acceptance rate of the algorithm is the conservation of energy, <span class="math notranslate nohighlight">\(H\)</span>, along the trajectory.
If the leapfrog integration has too large time steps, or the gradients of the misfit function are computed incorrectly (e.g., by badly discretizing the forward model), <span class="math notranslate nohighlight">\(H\)</span> is less well conserved, and the algorithm’s acceptance rate decreases.</p>
<p>The main cost of HMC, compared to other MCMC samplers, is the computation of the gradient <span class="math notranslate nohighlight">\(\partial U/\partial \mathbf{m}\)</span> at every step in the leapfrog propagation. When gradients can be computed easily, HMC can provide improved performance for two reasons: (1) the reduced cost of generating independent samples, that is, the avoidance of random-walk behaviour <span id="id7">[<a class="reference internal" href="#id803" title="R. M. Neal. MCMC using Hamiltonian dynamics. In Handbook of Markov Chain Monte Carlo, Chapter 5. 2011.">2</a>]</span>, and (2) the better scaling of HMC with increasing dimension <span id="id8">[<a class="reference internal" href="#id803" title="R. M. Neal. MCMC using Hamiltonian dynamics. In Handbook of Markov Chain Monte Carlo, Chapter 5. 2011.">2</a>, <a class="reference internal" href="#id238" title="Michael Creutz. Global monte carlo algorithms for many-fermion systems. Physical Review D, 38(4):1228, 1988.">3</a>]</span>.</p>
</section>
<section id="tuning-parameters">
<h2>Tuning parameters<a class="headerlink" href="#tuning-parameters" title="Permalink to this headline">#</a></h2>
<p>The tuning parameters in HMC are simulation time <span class="math notranslate nohighlight">\(\tau\)</span> and the mass matrix <span class="math notranslate nohighlight">\(\mathbf{m}\)</span>. HMC has the potential to inject additional knowledge about the distribution <span class="math notranslate nohighlight">\(p\)</span> via the mass matrix in order to enhance convergence significantly. At the same time, the abundance of tuning parameters also creates potential for choosing inefficient settings, leading to sub-optimal convergence. <span id="id9">Fichtner <em>et al.</em> [<a class="reference internal" href="#id366" title="A. Fichtner, A. Zunino, and L. Gebraad. Hamiltonian Monte Carlo solution of tomographic inverse problems. Geophys. J. Int., 216:doi:10.1093/gji/ggy496, 2018.">6</a>]</span> and <span id="id10">Fichtner and Zunino [<a class="reference internal" href="#id367" title="A. Fichtner and A. Zunino. Hamiltonian nullspace shuttles. Geophys. Res. Lett., 46:doi:10.1029/2018GL080931, 2019.">5</a>]</span> both illustrate how to create relevant mass matrices for tomographic inverse problems.</p>
<p>We adapt the specific tuning strategy for the mass matrix in this study depending on the target, as illustrated in the following  sections. However, for all targets we choose the size of the discrete time steps empirically such that the acceptance rate is close to the optimum of 65 % <span id="id11">[<a class="reference internal" href="#id803" title="R. M. Neal. MCMC using Hamiltonian dynamics. In Handbook of Markov Chain Monte Carlo, Chapter 5. 2011.">2</a>]</span>. This typically results in needing approximately 10 leap-frog steps per proposal, i.e. requiring this many forward and adjoint solves per proposal.</p>
</section>
<section id="further-reading">
<h2>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">#</a></h2>
<div class="docutils container" id="id12">
<dl class="citation">
<dt class="label" id="id299"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>S. Duane, A. D. Kennedy, B. J. Pendleton, and D. Roweth. Hybrid Monte Carlo. <em>Phys. Lett. B</em>, 195:216–222, 1987.</p>
</dd>
<dt class="label" id="id803"><span class="brackets">2</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id5">2</a>,<a href="#id6">3</a>,<a href="#id7">4</a>,<a href="#id8">5</a>,<a href="#id11">6</a>)</span></dt>
<dd><p>R. M. Neal. MCMC using Hamiltonian dynamics. In <em>Handbook of Markov Chain Monte Carlo</em>, Chapter 5. 2011.</p>
</dd>
<dt class="label" id="id238"><span class="brackets">3</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id8">2</a>)</span></dt>
<dd><p>Michael Creutz. Global monte carlo algorithms for many-fermion systems. <em>Physical Review D</em>, 38(4):1228, 1988.</p>
</dd>
<dt class="label" id="id636"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>L. D. Landau and E. M. Lifshitz. <em>Course of Theoretical Physics, Volume 1, Mechanics, 3rd edition</em>. Elsevier Butterworth Heinemann, Amsterdam, 1976.</p>
</dd>
<dt class="label" id="id367"><span class="brackets">5</span><span class="fn-backref">(<a href="#id5">1</a>,<a href="#id10">2</a>)</span></dt>
<dd><p>A. Fichtner and A. Zunino. Hamiltonian nullspace shuttles. <em>Geophys. Res. Lett.</em>, 46:doi:10.1029/2018GL080931, 2019.</p>
</dd>
<dt class="label" id="id366"><span class="brackets"><a class="fn-backref" href="#id9">6</a></span></dt>
<dd><p>A. Fichtner, A. Zunino, and L. Gebraad. Hamiltonian Monte Carlo solution of tomographic inverse problems. <em>Geophys. J. Int.</em>, 216:doi:10.1093/gji/ggy496, 2018.</p>
</dd>
</dl>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="setup.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Installation</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Home</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2019-2022, Andrea Zunino, Lars Gebraad, Andreas Fichtner
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">The Hamiltonian Monte Carlo algorithm</a><ul>
<li><a class="reference internal" href="#theory">Theory</a></li>
<li><a class="reference internal" href="#from-theory-to-code">From theory to code</a></li>
<li><a class="reference internal" href="#hmc-compared">HMC compared</a></li>
<li><a class="reference internal" href="#tuning-parameters">Tuning parameters</a></li>
<li><a class="reference internal" href="#further-reading">Further reading</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>